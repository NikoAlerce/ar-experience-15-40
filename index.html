<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>15 - AR Experience</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            overflow: hidden;
            position: relative;
        }
        
        /* Instrucciones simples */
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }
        
        /* Debug info opcional */
        .debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 10px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-line;
            z-index: 1000;
        }
        
        /* Forzar que todos los videos sean visibles */
        video {
            display: block !important;
            visibility: visible !important;
        }
        
        /* Asegurar que A-Frame canvas sea visible */
        a-scene canvas {
            display: block !important;
            visibility: visible !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
        }
        
        /* Video de respaldo para mÃ³viles */
        #backup-camera {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            z-index: -1 !important;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .loading-content h1 {
                font-size: 20px;
            }
            
            .loading-content p {
                font-size: 14px;
            }
            
            .camera-instructions {
                left: 16px;
                right: 16px;
                top: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Instrucciones simples -->
    <div class="instructions" id="instructions">
        ðŸŽ¯ Apunta la cÃ¡mara al marcador para ver <strong>15</strong>
    </div>
    
    <!-- Debug info opcional - visible en mÃ³viles para diagnosticar -->
    <div class="debug-info" id="debugInfo">
        Iniciando AR automÃ¡ticamente...
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./target.mind; maxTrack: 1; uiLoading: no; uiScanning: no; autoStart: true; uiError: no;"
        embedded
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights; antialias: true; alpha: true"
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        id="arScene">
        
        <a-assets>
            <video id="content-video" src="./assets/content_1757945128368_optimized.mp4" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity id="ar-content" mindar-image-target="targetIndex: 0">
            <a-video 
                id="ar-video"
                src="#content-video" 
                width="2" 
                height="1.5" 
                position="0 0 0"
                scale="1 1 1"
                material="transparent: true; alphaTest: 0.1"
                animation__appear="property: scale; from: 0 0 0; to: 1 1 1; dur: 1000; easing: easeOutBack; startEvents: targetFound"
                class="clickable">
              </a-video>
        </a-entity>
    </a-scene>

    <script>
        // JavaScript optimizado para cÃ¡mara funcionando en PC y mÃ³vil
        let instructions = document.getElementById('instructions');
        let debugInfo = document.getElementById('debugInfo');
        let logs = [];
        let cameraStream = null;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            const logMsg = time + ': ' + message;
            console.log(logMsg);
            logs.push(logMsg);
            if (debugInfo) {
                debugInfo.textContent = logs.slice(-6).join('\n');
            }
        }

        // Configurar eventos de tracking
        document.addEventListener('DOMContentLoaded', () => {
            const arContent = document.querySelector('#ar-content');
            
            arContent.addEventListener('targetFound', () => {
                log('ðŸŽ¯ Â¡Marcador encontrado!');
                instructions.textContent = 'âœ… Â¡Marcador detectado! Experiencia AR activa';
                instructions.style.background = 'rgba(0, 150, 0, 0.8)';
            });
            
            arContent.addEventListener('targetLost', () => {
                log('âŒ Marcador perdido');
                instructions.textContent = 'ðŸ” Busca el marcador para ver 15';
                instructions.style.background = 'rgba(0, 0, 0, 0.8)';
            });
        });

        // Auto-detectar dispositivo para logs
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isXiaomi = /Mi|Redmi|MIUI/i.test(navigator.userAgent);
        const isDesktop = !('ontouchstart' in window) && !navigator.maxTouchPoints;
        
        if (isXiaomi) {
            log('ðŸ”§ Xiaomi detectado - AR iniciando...');
        } else if (isAndroid) {
            log('ðŸ“± Android detectado - AR iniciando...');
        } else if (isDesktop) {
            log('ðŸ’» PC/Desktop detectado - AR iniciando...');
        } else {
            log('ðŸŒ Dispositivo detectado - AR iniciando...');
        }

        // FunciÃ³n para asegurar que la cÃ¡mara funcione en PC y mÃ³vil
        async function ensureCameraWorking() {
            try {
                log('ðŸ”§ Aplicando fix de cÃ¡mara universal...');
                
                // Esperar a que MindAR estÃ© listo
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // ConfiguraciÃ³n especÃ­fica por dispositivo
                let constraints;
                if (isDesktop) {
                    constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        },
                        audio: false
                    };
                } else {
                    // ConfiguraciÃ³n para mÃ³viles
                    constraints = {
                        video: {
                            facingMode: { exact: 'environment' }, // CÃ¡mara trasera preferida
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 }
                        },
                        audio: false
                    };
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                log('âœ… Stream de cÃ¡mara obtenido');
                
                // Buscar el video de MindAR e inyectar nuestro stream
                const findAndInjectVideo = () => {
                    const videos = document.querySelectorAll('video');
                    let mindARVideo = null;
                    
                    // Buscar video de MindAR de varias formas
                    for (let video of videos) {
                        if (video.getAttribute('data-mindar-video') || 
                            video.parentElement?.tagName === 'A-SCENE' ||
                            video.style.position === 'absolute' ||
                            video.style.transform ||
                            video.width > 100) {
                            mindARVideo = video;
                            break;
                        }
                    }
                    
                    if (mindARVideo && cameraStream) {
                        mindARVideo.srcObject = cameraStream;
                        mindARVideo.play();
                        mindARVideo.style.display = 'block';
                        mindARVideo.style.visibility = 'visible';
                        log('âœ… Stream inyectado en video MindAR');
                        return true;
                    }
                    return false;
                };
                
                // Si no encuentra video de MindAR, crear uno manual
                const createBackupVideo = () => {
                    if (!document.getElementById('backup-camera')) {
                        const backupVideo = document.createElement('video');
                        backupVideo.id = 'backup-camera';
                        backupVideo.autoplay = true;
                        backupVideo.playsinline = true;
                        backupVideo.muted = true;
                        backupVideo.srcObject = cameraStream;
                        backupVideo.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100vw;
                            height: 100vh;
                            object-fit: cover;
                            z-index: -1;
                        `;
                        document.body.appendChild(backupVideo);
                        log('ðŸ“¹ Video de respaldo creado');
                        return true;
                    }
                    return false;
                };
                
                // Intentar inyectar en MindAR varias veces
                let attempts = 0;
                const maxAttempts = 15;
                const injectInterval = setInterval(() => {
                    const injected = findAndInjectVideo();
                    
                    if (injected) {
                        clearInterval(injectInterval);
                        log('ðŸŽ¯ CÃ¡mara configurada con MindAR');
                    } else if (attempts >= maxAttempts) {
                        clearInterval(injectInterval);
                        createBackupVideo();
                        log('âš ï¸ Usando video de respaldo');
                    }
                    attempts++;
                }, 800);
                
            } catch (error) {
                log('âŒ Error configurando cÃ¡mara: ' + error.message);
                
                // Fallback: intentar con facingMode 'user' en mÃ³vil
                if (!isDesktop && error.name === 'OverconstrainedError') {
                    try {
                        log('ðŸ”„ Reintentando con cÃ¡mara frontal...');
                        const fallbackConstraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            },
                            audio: false
                        };
                        cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                        log('âœ… CÃ¡mara frontal obtenida como fallback');
                    } catch (fallbackError) {
                        log('âŒ Error en fallback: ' + fallbackError.message);
                    }
                }
            }
        }

        // Escuchar eventos de A-Frame y MindAR
        window.addEventListener('load', () => {
            log('ðŸš€ PÃ¡gina cargada');
            const arScene = document.querySelector('a-scene');
            
            arScene.addEventListener('loaded', () => {
                log('âœ… Escena A-Frame cargada');
                // Aplicar fix de cÃ¡mara despuÃ©s de que A-Frame estÃ© listo
                ensureCameraWorking();
            });
            
            arScene.addEventListener('renderstart', () => {
                log('ðŸ“¹ Renderer iniciado');
            });
            
            // Eventos especÃ­ficos de MindAR
            arScene.addEventListener('arReady', () => {
                log('ðŸŽ¯ MindAR listo');
            });
            
            arScene.addEventListener('arError', (event) => {
                log('âŒ Error MindAR: ' + (event.detail ? event.detail.error : 'Error desconocido'));
            });
        });

        // Monitorear el estado de la cÃ¡mara con mÃ¡s detalle
        let cameraCheckInterval = setInterval(() => {
            const video = document.querySelector('video[data-mindar-video]') || 
                         document.querySelector('canvas[data-mindar-canvas]') ||
                         document.querySelector('a-scene video');
            
            if (video) {
                if (video.srcObject && video.srcObject.active) {
                    log('ðŸ“¹ CÃ¡mara activa en MindAR');
                    clearInterval(cameraCheckInterval);
                } else if (video.srcObject) {
                    log('âš ï¸ MindAR tiene video pero sin stream activo');
                }
            }
        }, 3000);

        // Detener monitoreo despuÃ©s de 30 segundos
        setTimeout(() => {
            clearInterval(cameraCheckInterval);
        }, 30000);

        // Manejar errores
        window.addEventListener('error', (event) => {
            log('âŒ Error: ' + event.message);
        });

        // Prevenir zoom en mÃ³viles
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('gesturechange', e => e.preventDefault());
        document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
    </script>
</body>
</html>